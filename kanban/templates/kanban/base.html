{% load static %}
<!doctype html>
<html lang="en">
<head>
 <meta charset="utf-8">
 <meta http-equiv="x-ua-compatible" content="ie=edge">
 <meta name="description" content="">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>AE Stocks</title>
 <script src="//bensmithett.github.io/dragster/lib/dragster.js"></script>
 <link rel="stylesheet" href="{% static 'css/kanban.css' %}">
</head>

<body>
 {% block content %}{% endblock %}

 <h1>아프리카 코끼리</h1>

 {% for board in boards %} 
 <h2>{{ board.name }}</h2>

 <!-- Top30 메인 리스트 / 별도 db 사용 / 수정 불가 -->
  <div class="board">
    <div class="column">
        <h3>Top 30</h3>
        {% for card in tops %}
        <a class="card" draggable="true" data-card-title="{{ card.title }}">{{ card.title }} {{ card.rate }} {{ card.market }} </a>
        {% endfor %}
    </div>
 
    <!-- 종목 정리용 리스트 / 생성, 삭제 가능 / 리스트는 메인리스트에서 가져옴 -->
    {% for column in board.columns.all %}
    <div class="column" data-column-id="{{ column.id }}">
      <div class="c-title" style="float:left">
        <!-- 컬럼 타이틀 -->
        <form action="/new-col-name/" method="POST">
          {% csrf_token %}
          <input id="c-title-hidden" type="hidden" name="column_id" value="{{ column.id }}" />
          <input id ="c-title-text" type="text" name="title" class="new-col-name no-display" data-column-id="{{ column.id }}" />
        </form>
        <button id="c-title-button" class="column-title" data-column-id="{{ column.id }}">{{ column.title }}</button>
      </div>

      <!-- 컬럼 삭제 버튼  -->
      <div class="c-delete" sytle="float:right">
        <form action="/delete-column/" method="POST" >
          {% csrf_token %}
          <input type="hidden" name="column_id" value="{{ column.id }}" />
          <button class="delete-button" type='submit'>delete</button>
        </form>
      </div>
   
        {% for card in column.cards.all %}
        <a class="card" draggable="true" data-card-title="{{ card.title }}" href="/cards/{{ card.id }}/{{ card.slug }}/">{{ card.title }}</a>
        {% endfor %}

        <form action="/new-card/" method="POST">
          {% csrf_token %}
          <input type="hidden" name="column_id" value="{{ column.id }}" />
          <input id ="new-card-text" type="text" name="title" class="new-card no-display" data-column-id="{{ column.id }}" />
        </form>
        <button id="add-card-button" class="show-new-card" data-column-id="{{ column.id }}">+ Add a card</button>
      </div>
      {% endfor %}
    <!-- 새 컬럼 추가 버튼 -->
    <form action="/new-list/" method="POST">
      {% csrf_token %}
      <input type="hidden" name="board_id" value="{{ board.id }}" />
      <input id="add-list-text" type="text" name="title" class="new-list no-display" data-board-id="{{ board.id }}" />
    </form>
    <button id="add-list-button" class="show-new-list" data-board-id="{{ board.id }}">+ Add a new list</button>
  </div>
 
  {% empty %}
  <p><em>No boards created yet!</em></p>
  {% endfor %}

 <script>
   
  function parse_cookies() {
   var cookies = {};
   if (document.cookie && document.cookie !== '') {
    document.cookie.split(';').forEach(function (c) {
     var m = c.trim().match(/(\w+)=(.*)/);
     if(m !== undefined) {
      cookies[m[1]] = decodeURIComponent(m[2]);
     }
    });
   }
   return cookies;
  }
  const cookies = parse_cookies();
   
  // 새 카드 만드는 버튼 액션 정의
  for (button of document.getElementsByClassName('show-new-card')) {
    button.addEventListener('click', e => {
      const newCard = document.querySelector('.new-card[data-column-id="' + e.currentTarget.dataset.columnId + '"]');
      newCard.classList.remove('no-display');
      newCard.focus();

      document.onclick = function(a) {
        if(a.target.id !== 'c-title-text' && a.target.id !== 'c-title-button' && a.target.id !== 'add-card-button' && a.target.id !== 'add-list-button') {
          newCard.classList.add('no-display');
        };  
      };

      document.onkeydown = function(e) {
      if(e.keyCode === 27){
        newCard.classList.add('no-display');
        // showMe.classList.remove('no-display');
        };
      };
    });
  }

  // 새 리스트 만드는 버튼 액션 정의 
  for (button of document.getElementsByClassName('show-new-list')) {
   button.addEventListener('click', e => {
    const newList = document.querySelector('.new-list[data-board-id="' + e.currentTarget.dataset.boardId + '"]');
    const showMe = e.currentTarget;
    newList.classList.remove('no-display');
    e.currentTarget.classList.add('no-display');
    newList.focus();

    document.onclick = function(e) {
      if(e.target.id !== 'c-title-text' && e.target.id !== 'c-title-button' && e.target.id !== 'add-card-button' && e.target.id !== 'add-list-button'){
        newList.classList.add('no-display');
        showMe.classList.remove('no-display');
      };
    };

    document.onkeydown = function(e) {
      if(e.keyCode === 27){
        newList.classList.add('no-display');
        showMe.classList.remove('no-display');
      };
    };
   });
  }

  // 리스트 이름 클릭에 관련된 액션
  for (button of document.getElementsByClassName('column-title')) {
   button.addEventListener('click', e => {
    const newColName = document.querySelector('.new-col-name[data-column-id="' + e.currentTarget.dataset.columnId + '"]');
    const showMe = e.currentTarget;
    newColName.classList.remove('no-display');
    e.currentTarget.classList.add('no-display');
    newColName.focus();

    document.onclick = function(e) {
      if(e.target.id !== 'c-title-text' && e.target.id !== 'c-title-button' && e.target.id !== 'add-card-button' && e.target.id !== 'add-list-button'){
        newColName.classList.add('no-display');
        showMe.classList.remove('no-display');
      };
    };

    document.onkeydown = function(e) {
      if(e.keyCode === 27){
        newColName.classList.add('no-display');
        showMe.classList.remove('no-display');
       };
      };
    });
  }

  for (card of document.getElementsByClassName('card')) {
   card.addEventListener('dragstart', e => {
    e.dataTransfer.setData('Text', e.currentTarget.dataset.cardTitle);
   });
  }

  for (element of document.getElementsByClassName('column')) {
   new Dragster(element);
   element.addEventListener('dragover', e => {
    if (e.preventDefault) e.preventDefault();
   });
   element.addEventListener('dragster:enter', e => {
    e.currentTarget.classList.add('dropme')
   });
   element.addEventListener('dragster:leave', e => {
    e.currentTarget.classList.remove('dropme')
   });
   element.addEventListener('drop', e => {
    e.currentTarget.classList.remove('dropme')
    const postData = JSON.stringify({
     'column_id': e.currentTarget.dataset.columnId,
     'card_title': e.dataTransfer.getData('Text'),
    });

    fetch('/drop/', {
     credentials: 'same-origin',
     method: 'post',
     headers: {
      'X-CSRFToken': cookies['csrftoken'],
     },
     body: postData,
    }).then(response => {
     if (response.ok) {
      window.location = '/';
     } else {
      alert('Error! ' + response.statusText);
     }
    });

   });
  }
 </script>

</body>
</html>
